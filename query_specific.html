<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查詢特定資料</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background-color: #45a049;
        }

        .field-group {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .remove-field {
            background-color: #f44336;
        }

        .remove-field:hover {
            background-color: #da190b;
        }

        .column-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .required {
            color: red;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #666;
            text-decoration: none;
        }

        .back-link:hover {
            color: #333;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .result-table th,
        .result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .result-table th {
            background-color: #f5f5f5;
        }

        .result-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .result-table tr:hover {
            background-color: #f0f0f0;
        }

        .no-results {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .result-count {
            margin-top: 10px;
            color: #666;
        }
    </style>
</head>

<body>
    <a href="index.html" class="back-link">← 返回主選單</a>
    <h1>查詢特定資料</h1>

    <div class="form-group">
        <label for="tableName">資料表名稱：</label>
        <input type="text" id="tableName" required>
        <button onclick="loadTableColumns()">載入欄位</button>
    </div>

    <div id="fieldsContainer">
        <!-- 動態欄位將在這裡生成 -->
    </div>

    <button onclick="addField()">新增條件</button>
    <button onclick="submitQuery()">查詢資料</button>

    <div id="resultContainer">
        <!-- 查詢結果將在這裡顯示 -->
    </div>

    <script>
        let tableColumns = [];
        let selectedColumns = new Set();

        async function loadTableColumns() {
            const tableName = document.getElementById('tableName').value;
            if (!tableName) {
                alert('請輸入資料表名稱');
                return;
            }

            try {
                const response = await fetch(`http://localhost/get_ele/main.php?table=${encodeURIComponent(tableName)}`);
                const data = await response.json();

                if (data.status === 'success') {
                    tableColumns = data.data.columns;
                    selectedColumns.clear();
                    document.getElementById('fieldsContainer').innerHTML = '';
                    addField(); // 自動新增第一個欄位
                } else {
                    alert('載入欄位失敗：' + data.message);
                }
            } catch (error) {
                alert('載入欄位時發生錯誤：' + error.message);
            }
        }

        function updateAllColumnSelectors() {
            const selects = document.querySelectorAll('.column-select');
            const selectedValues = Array.from(selects).map(select => select.value);

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">請選擇欄位</option>';

                tableColumns.forEach(column => {
                    const option = document.createElement('option');
                    option.value = column.name;
                    option.textContent = column.name;

                    if (selectedValues.includes(column.name) && column.name !== currentValue) {
                        option.disabled = true;
                    }

                    if (column.name === currentValue) {
                        option.selected = true;
                    }

                    select.appendChild(option);
                });
            });
        }

        function addField() {
            const container = document.getElementById('fieldsContainer');
            const fieldGroup = document.createElement('div');
            fieldGroup.className = 'field-group';

            const columnSelect = document.createElement('select');
            columnSelect.className = 'column-select';
            columnSelect.onchange = function () {
                updateAllColumnSelectors();
                updateColumnInfo(this);
            };

            const operatorSelect = document.createElement('select');
            operatorSelect.innerHTML = `
                <option value="=">=</option>
                <option value="!=">!=</option>
                <option value=">">></option>
                <option value="<"><</option>
                <option value=">=">>=</option>
                <option value="<="><=</option>
                <option value="LIKE">LIKE</option>
                <option value="IN">IN</option>
                <option value="NOT IN">NOT IN</option>
                <option value="BETWEEN">BETWEEN</option>
            `;

            const valueInput = document.createElement('input');
            valueInput.type = 'text';
            valueInput.placeholder = '請輸入值 (多個值請用逗號分隔)';

            const removeButton = document.createElement('button');
            removeButton.textContent = '移除條件';
            removeButton.className = 'remove-field';
            removeButton.onclick = function () {
                container.removeChild(fieldGroup);
                updateAllColumnSelectors();
            };

            const columnInfo = document.createElement('div');
            columnInfo.className = 'column-info';

            fieldGroup.appendChild(columnSelect);
            fieldGroup.appendChild(operatorSelect);
            fieldGroup.appendChild(valueInput);
            fieldGroup.appendChild(removeButton);
            fieldGroup.appendChild(columnInfo);
            container.appendChild(fieldGroup);

            updateAllColumnSelectors();
        }

        function updateColumnInfo(select) {
            const columnName = select.value;
            const columnInfo = select.parentElement.querySelector('.column-info');
            const column = tableColumns.find(col => col.name === columnName);

            if (column) {
                let info = [];
                if (column.null === 'NO') {
                    info.push('<span class="required">必填</span>');
                }
                if (column.default !== null) {
                    info.push(`預設值: ${column.default}`);
                }
                if (column.extra) {
                    info.push(`額外: ${column.extra}`);
                }
                columnInfo.innerHTML = info.join(' | ');
            } else {
                columnInfo.innerHTML = '';
            }
        }

        function createTable(data) {
            if (!data || data.length === 0) {
                return '<div class="no-results">沒有符合條件的資料</div>';
            }

            const table = document.createElement('table');
            table.className = 'result-table';

            // 建立表頭
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // 建立表格內容
            const tbody = document.createElement('tbody');
            data.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    const td = document.createElement('td');
                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            // 添加結果計數
            const countDiv = document.createElement('div');
            countDiv.className = 'result-count';
            countDiv.textContent = `共找到 ${data.length} 筆資料`;

            const container = document.createElement('div');
            container.appendChild(table);
            container.appendChild(countDiv);

            return container;
        }

        async function submitQuery() {
            const tableName = document.getElementById('tableName').value;
            if (!tableName) {
                alert('請輸入資料表名稱');
                return;
            }

            const conditions = [];
            const fields = document.querySelectorAll('.field-group');

            fields.forEach(field => {
                const column = field.querySelector('.column-select').value;
                const operator = field.querySelector('select:nth-child(2)').value;
                const value = field.querySelector('input').value;
                if (column && value) {
                    conditions.push({
                        column: column,
                        operator: operator,
                        value: value
                    });
                }
            });

            try {
                const response = await fetch('http://localhost/query_data/main.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        table: tableName,
                        conditions: conditions
                    })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    const resultContainer = document.getElementById('resultContainer');
                    resultContainer.innerHTML = '';
                    resultContainer.appendChild(createTable(result.data));
                } else {
                    alert('查詢失敗：' + result.message);
                }
            } catch (error) {
                alert('發生錯誤：' + error.message);
            }
        }
    </script>
</body>

</html>